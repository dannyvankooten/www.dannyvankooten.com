<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/styles.css?v=202310222">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="icon" href="/img/favicon.png" type="image/png">
</head>
<body>
<header class="site-header">
    <nav class="container">
        <ul>
            <li class="home"><a href="/" rel="home">Danny van Kooten</a></li>
            <li><a href="/about/">About me</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="/contact/">Contact</a></li>
        </ul>
    </nav>
</header>
<main>
    <div class="container">

<h1>Preparing videos for Mastodon using ffmpeg</h1>
    <p>Recently I was recording a screencast of <a href="https://toot.re/@dvk/111342580812680580">me launching Koko Analytics as a Progressive Web App from my OS launcher</a>.
Trying to upload the video to Mastodon failed with the following error message:</p>
<blockquote>
<p>422 1000fps videos are not supported</p>
</blockquote>
<p>According to the <a href="https://docs.joinmastodon.org/user/posting/">Mastodon documentation</a>, the following limits are in place for video uploads:</p>
<ul>
<li>Supported formats: MP4, M4V, MOV, WebM</li>
<li>Maximum size: 40MB</li>
<li>Maximum bitrate: 1300kbps</li>
<li>Maximum framerate: 60fps</li>
</ul>
<p>The documentation does not state anything about a maximum resolution, but <a href="https://www.paulox.net/2022/11/17/resize-a-video-with-ffmpeg-for-mastodon/">other sources</a> stated a video could be no larger than 1920 x 1200 px.</p>
<h2>Downsample video resolution, fps and bitrate using ffmpeg</h2>
<p><a href="https://www.ffmpeg.org/">ffmpeg</a> is an incredible piece of software to convert video between various formats.</p>
<p>To use it to downsample a video to match the Mastodon requirements, we can use the following command:</p>
<pre><code class="language-sh">ffmpeg                              \
  -i in.webm                        \
  -filter:v scale=1900:-1,fps=60    \
  out.webm
</code></pre>
<p>This resizes the video to 1900px wide while preserving the aspect ratio.
It also limits the framerate to 60 fps.</p>
<p>If your video has a bitrate higher than 1300kbps, instruct the encoder to aim for a lower bitrate using the <code>-b:v</code> argument.</p>
<pre><code class="language-sh">ffmpeg                                    \
  -i in.webm                              \
  -filter:v scale=1900:-1,fps=60          \
  -b:v 1300k -maxrate 1300k -bufsize=650k \
  out.webm
</code></pre>
<p>Since <code>-b:v</code> specifies the target (average) bitrate for the encoder to use, specifying it only makes sense if your video has a larger bitrate than what is required by Mastodon.</p>
<p>I had to do a bit of browsing around to find the proper set of arguments, so hopefully sharing this here helps someone shave a few minutes off their day.</p>
<h2>Resources</h2>
<ul>
<li><a href="http://trac.ffmpeg.org/wiki/Scaling#KeepingtheAspectRatio">Scaling - ffmpeg</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/ChangingFrameRate">Changing the framerate - ffmpeg</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/Limiting%20the%20output%20bitrate">Limiting the output bitrate - ffmpeg</a></li>
</ul>

</div>
</main>
<footer class="container site-footer">
    <div class="footer-col mb">
        <ul class="nolist">
            <li><a href="/about/" style="font-weight: bold; text-decoration: none;">About me</a></li>
            <li><a href="/bookmarks/">Bookmarks</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="/code/">Code</a></li>
            <li><a href="/contact/">Contact me</a></li>
        </ul>
    </div>
    <div class="footer-col mb">
        <ul class="nolist">
            <li><a href="/projects/" style="font-weight: bold; text-decoration: none;">Projects</a></li>
            <li><a href="https://www.mc4wp.com/">Mailchimp for WordPress</a></li>
            <li><a href="https://www.kokoanalytics.com/">Koko Analytics</a></li>
            <li><a href="https://www.htmlformsplugin.com/">HTML Forms plugin</a></li>
        </ul>
    </div>
    <p style="clear:both;">Find me on <a href="https://git.sr.ht/~dvko/" class="icon sourcehut" rel="me nofollow author">sourcehut</a>,
        <a href="https://github.com/dannyvankooten/" class="icon github" rel="me nofollow author">GitHub</a> and <a rel="me" href="https://toot.re/@dvk" class="icon mastodon">Mastodon</a>.
    </p>
    <p>This website is statically built using <a href="https://www.getzola.org/">Zola</a>. You can find <a href="https://git.sr.ht/~dvko/dannyvankooten.com" rel="nofollow">its source code here</a>.</p>
    <p>Pageviews for this site are counted using a standalone spin-off of Koko Analytics, code-named <a href="https://teller.dvk.co/">Teller</a>.</p>
</footer>
<script>
    ((t, cnf) => {
        window[t] = cnf;
        let s = document.createElement('script');
        s.defer = true;
        s.src = [cnf.url, '/assets/', t, '.min.js'].join('');
        document.body.appendChild(s)
    })('teller', {
        url: 'https://teller.dvk.co',
        site: '433ca337-2a49-4391-a340-e3c3bbbb32d3'
    })
</script>
</body>
</html>

