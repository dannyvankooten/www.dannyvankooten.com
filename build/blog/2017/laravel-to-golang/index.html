<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/styles.css?v=202310222">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="icon" href="/img/favicon.png" type="image/png">
</head>
<body>
<header class="site-header">
    <nav class="container">
        <ul>
            <li class="home"><a href="/" rel="home">Danny van Kooten</a></li>
            <li><a href="/about/">About me</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="/contact/">Contact</a></li>
        </ul>
    </nav>
</header>
<main>
    <div class="container">

<h1>Moving from PHP (Laravel) to Go</h1>
    <p>Earlier this year, I made an arguably bad business decision. I decided to rewrite the Laravel application powering <a href="https://my.boxzillaplugin.com/">Boxzilla</a> in <a href="https://golang.org/">Go</a>.</p>
<p>No regrets though.</p>
<img style="height: 400px; width: auto;" class="small-margin" src="/media/2017/2017-04-boxzilla-platform.jpg">
<p>Just a few weeks later I was deploying the Go application. Building it was the most fun I had in months, I learned a ton and the end result is a huge improvement over the old application. Better performance, easier deployments and higher test coverage.</p>
<p>The application is a fairly straightforward database driven API &amp; account area where users can log-in to download the product, view their invoices or update their payment method.</p>
<p><a href="https://stripe.com/">Stripe</a> and <a href="https://www.braintreepayments.com/">Braintree</a> are used to accept subscription payments. Invoices are handled using <a href="https://www.moneybird.com/">MoneyBird</a> and some transactional emails are sent using <a href="https://www.mailgun.com/">Mailgun</a>.</p>
<p>While Laravel worked well enough for this, some things always felt overcomplicated to me. And what's with releasing a new &quot;major&quot; version every few months? I'd be fine if the newer versions contained significant improvements, but a lot of times it just felt like minor naming &amp; directory structure changes to me.</p>
<h2>Why Go?</h2>
<p>Last year I've been moving several services over to Go, so I wasn't completely new to the language. As a developer selling WordPress based products, part of my job is working in an ancient tech stack that is mostly focused on the end user.</p>
<p>If I weren't self-employed, I would simply apply for a new job to make up for this lack of sexy tech. Being my own boss, I owe it to myself to make my day-to-day work fun and not just chase more immediate $$$. If revenue allows (and it does), why not have a little fun?</p>
<p>It's a joy to write Go code, the tooling is amazing and it's not only fast to develop in, the end result is usually crazy fast too. Just reading about <a href="https://golang.org/doc/faq#What_is_the_purpose_of_the_project">the purpose of the Go project</a> sold me on the language.</p>
<p>I think we'll see a good amount of people switching from dynamically typed languages like PHP, Python and JavaScript to Go in the next few years.</p>
<h2>Porting the codebase</h2>
<p>Migrating the code to Go consisted mostly about getting the database interaction right &amp; porting the Blade templates to something we could use in Go.</p>
<p>ORM's are one thing that always end up getting in my way, so I went for a mockable data access layer and plain SQL queries. <a href="https://github.com/russross/meddler">Meddler</a> was used to get rid of some of the boilerplate for scanning query results into structs.</p>
<p>To support hierarchical templates and partials I open-sourced <a href="https://github.com/dannyvankooten/grender">grender</a>, a tiny wrapper around Go's standard html/template package. This allowed me to port the Blade template files to Go with relative ease, since I could use the same hierarchical structure and partial templates.</p>
<p>For integrating with Stripe there is the official <a href="https://github.com/stripe/stripe-go">stripe-go</a> package. For Braintree there is the unofficial <a href="https://github.com/lionelbarrow/braintree-go">braintree-go</a> package, which was neglected for a little while but received renewed attention lately. Since there was no Go package to manage invoices in Moneybird yet, I built and open-sourced <a href="https://github.com/dannyvankooten/moneybird-go">moneybird-go</a>.</p>
<h2>Comparing apples vs oranges</h2>
<p>Since Go is a compiled language with a much better standard library than PHP, it is not really fair to compare the two languages like I am about to. That said, I thought it would be fun to share some numbers.</p>
<h4>Performance</h4>
<p><a href="https://github.com/wg/wrk">wrk</a> was used to perform some simple HTTP benchmarks for both applications returning the HTML for the login page.</p>
<div style="overflow-x: auto;">
<table>
<thead>
<tr>
<th></th>
<th>Concurrency</th>
<th>Avg. latency</th>
<th>Req / sec</th>
<th>Transfer / sec</th>
</tr>
</thead>
<tbody>
<tr>
<td>Laravel</td>
<td>1</td>
<td>3.87ms</td>
<td>261.48</td>
<td>1.27MB</td>
</tr>
<tr>
<td>Laravel</td>
<td>100</td>
<td>108.86ms</td>
<td>917.27</td>
<td>6.04MB</td>
</tr>
<tr>
<td>Go</td>
<td>1</td>
<td>325.72Î¼s</td>
<td>7365.48</td>
<td>34.27MB</td>
</tr>
<tr>
<td>Go</td>
<td>100</td>
<td>11.63ms</td>
<td>19967.31</td>
<td>92.91MB</td>
</tr>
<tr>
<td>Go</td>
<td>200</td>
<td>37.68ms</td>
<td>22653.22</td>
<td>105.41MB</td>
</tr>
</tbody>
</table>
</div>
<p>Unfortunately, the Laravel application (or PHP-FPM socket) kept falling over once I increased the number of concurrent &quot;users&quot; past 100.</p>
<p><a href="https://my-netdata.io/">NetData</a> provided the following graphs to see how the server was holding up under all this load.</p>
<p><strong>Go with 100 concurrent connections</strong>
<a href="/media/2017/2017-benchmark-go-c100.jpg"><img src="/media/2017/2017-benchmark-go-c100.jpg" alt="Go with 100 concurrent connections"></a></p>
<p><strong>Laravel with 100 concurrent connections</strong>
<a href="/media/2017/2017-benchmark-laravel-c100.jpg"><img src="/media/2017/2017-benchmark-laravel-c100.jpg" alt="Laravel with 100 concurrent connections"></a></p>
<p>Please note that I ran the benchmark from the same machine as the applications were running on, so this heavily influences both graphs.</p>
<h4>Lines of code</h4>
<p>Let's compare the lines of code in both applications, including all vendored dependencies.</p>
<pre><code>$ find . -name '*.php' | xargs wc -l
156289 total
</code></pre>
<p>The Laravel version consists of just over 156.000 lines of code. This is excluding development dependencies which, with Laravel, are needed to run tests etc.</p>
<pre><code>$ find . -name '*.go' | xargs wc -l
33624 total
</code></pre>
<p>The Go version on the other hand consists of 33.000 lines of code. That's one fifth of the code for exactly the same functionality.</p>
<p>Let's exclude external dependencies in the Laravel application so we know how much lines were actually written by me.</p>
<pre><code>$ find . -name '*.php' -not -path &quot;./vendor/*&quot; | xargs wc -l
13921 total
</code></pre>
<p>And for Go.</p>
<pre><code>$ find . -name '*.go' -not -path &quot;./vendor/*&quot; | xargs wc -l
6750 total
</code></pre>
<p>The result is slightly more even when just looking at managed lines of code. Still, it's the exact same application with half the amount of code.</p>
<h4>Test coverage</h4>
<p>Testing is a first class citizen in Go, and test files live right next to the actual source files.</p>
<pre><code>license.go
license_test.go
subscription.go
subscription_test.go
</code></pre>
<p>This makes it incredibly convenient to apply test driven development.</p>
<p>In our Laravel application we mostly had integration tests that checked whether the request handlers returned a proper response. Overall test coverage was quite low, mostly due to tight coupling which in turn was mostly my fault. Writing the same application a second time really helps here too.</p>
<h2>TLDR</h2>
<p>Did something you should never do: rewrote an application in a different language because I felt like it. Had lots of fun and got a much smaller &amp; faster application in return.</p>
<hr>
<p><strong>Edited on April 19:</strong> 120ms latency with lots of disk writing for the Laravel benchmark didn't seem right so I revisited it. Turns out I had <code>APP_DEBUG</code> set to <code>true</code>, so templates were recompiled on every request. Oops. The post has been updated with the correct benchmarking results.</p>

</div>
</main>
<footer class="container site-footer">
    <div class="footer-col mb">
        <ul class="nolist">
            <li><a href="/about/" style="font-weight: bold; text-decoration: none;">About me</a></li>
            <li><a href="/bookmarks/">Bookmarks</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="/code/">Code</a></li>
            <li><a href="/contact/">Contact me</a></li>
        </ul>
    </div>
    <div class="footer-col mb">
        <ul class="nolist">
            <li><a href="/projects/" style="font-weight: bold; text-decoration: none;">Projects</a></li>
            <li><a href="https://www.mc4wp.com/">Mailchimp for WordPress</a></li>
            <li><a href="https://www.kokoanalytics.com/">Koko Analytics</a></li>
            <li><a href="https://www.htmlformsplugin.com/">HTML Forms plugin</a></li>
        </ul>
    </div>
    <p style="clear:both;">Find me on <a href="https://git.sr.ht/~dvko/" class="icon sourcehut" rel="me nofollow author">sourcehut</a>,
        <a href="https://github.com/dannyvankooten/" class="icon github" rel="me nofollow author">GitHub</a> and <a rel="me" href="https://toot.re/@dvk" class="icon mastodon">Mastodon</a>.
    </p>
    <p>This website is statically built using <a href="https://www.getzola.org/">Zola</a>. You can find <a href="https://git.sr.ht/~dvko/dannyvankooten.com" rel="nofollow">its source code here</a>.</p>
    <p>Pageviews for this site are counted using a standalone spin-off of Koko Analytics, code-named <a href="https://teller.dvk.co/">Teller</a>.</p>
</footer>
<script>
    ((t, cnf) => {
        window[t] = cnf;
        let s = document.createElement('script');
        s.defer = true;
        s.src = [cnf.url, '/assets/', t, '.min.js'].join('');
        document.body.appendChild(s)
    })('teller', {
        url: 'https://teller.dvk.co',
        site: '433ca337-2a49-4391-a340-e3c3bbbb32d3'
    })
</script>
</body>
</html>

